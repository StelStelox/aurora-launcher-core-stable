"use strict";var z=Object.create;var d=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var A=(o,t)=>{for(var r in t)d(o,r,{get:t[r],enumerable:!0})},b=(o,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of k(t))!N.call(o,s)&&s!==r&&d(o,s,{get:()=>t[s],enumerable:!(e=$(t,s))||e.enumerable});return o};var R=(o,t,r)=>(r=o!=null?z(B(o)):{},b(t||!o||!o.__esModule?d(r,"default",{value:o,enumerable:!0}):r,o)),W=o=>b(d({},"__esModule",{value:!0}),o);var j={};A(j,{Action:()=>E,HashHelper:()=>a,HttpHelper:()=>w,JsonHelper:()=>p,Name:()=>O,StorageHelper:()=>u,ZipHelper:()=>y});module.exports=W(j);var g=require("fs/promises"),v=require("path"),L=R(require("p-map"));var T=require("fs"),m=require("undici"),w=class{static concurrency=4;static setConcurrency(t){this.concurrency=t}static async existsResource(t){try{let{statusCode:r}=await(0,m.request)(t,{method:"HEAD"});return r>=200&&r<300}catch{return!1}}static async getResource(t){let{body:r}=await(0,m.request)(t);return r.text()}static async getResourceFromJson(t){return p.fromJson(await this.getResource(t))}static async postJson(t,r){let{body:e}=await(0,m.request)(t,{method:"POST",body:p.toJson(r),headers:{"Content-Type":"application/json"}});return await e.json()}static downloadFile(t,r,e={saveToTempFile:!1}){if(e.saveToTempFile&&(r=u.getTmpPath()),r===null)throw new Error("File path not found");return this.download(t,r,e.onProgress)}static async downloadSafeFile(t,r,e={}){if(r===null)throw new Error("File path not found");return await this.download(t,`${r}.safe`,e.onProgress),await(0,g.rename)(`${r}.safe`,r)}static async downloadFiles(t,r={}){await(0,L.default)(t,async e=>{if(await this.verifyFileHash(e)){r.afterDownload&&r.afterDownload({url:e.sourceUrl});return}await this.download(e.sourceUrl,e.destinationPath,r.onProgress,r.beforeDownload,r.afterDownload)},{concurrency:this.concurrency})}static async download(t,r,e,s,c){await(0,g.mkdir)((0,v.dirname)(r),{recursive:!0});let{statusCode:i,headers:n,body:l}=await(0,m.request)(t);if(i>=400)throw new Error(`Failed to download ${t} with status code ${i}`);let F=n.location;if(i>300&&i<400&&F)return this.download(F,r,e,s,c);if(e){let f=0,h=+(n["content-length"]||0);l.on("data",x=>{e({url:t,transferred:f+=x.byteLength,total:h})})}return s&&s({url:t}),new Promise((f,h)=>{l.pipe((0,T.createWriteStream)(r)).on("finish",()=>{f(r),c&&c({url:t})}).on("error",x=>h(x))})}static async verifyFileHash(t){if(!t.sha1)return!1;let r;try{r=await a.getHashFromFile(t.destinationPath,"sha1")}catch{return!1}return t.sha1===r}};var p=class{static fromJson(t){return JSON.parse(t)}static toJson(t,r=!1){return r?JSON.stringify(t,null,4):JSON.stringify(t)}};var P=require("crypto"),U=require("os"),J=require("path"),u=class{static getTmpPath(){return(0,J.resolve)((0,U.tmpdir)(),(0,P.randomBytes)(16).toString("hex"))}};var S=require("crypto"),D=require("fs/promises"),a=class{static getHash(t,r){return(0,S.createHash)(r).update(t).digest("hex")}static async getHashFromFile(t,r){return this.getHash(await(0,D.readFile)(t),r)}};var H=require("path"),C=R(require("adm-zip"));var y=class{static unzip(t,r,e=[],s){let c=new C.default(t),i=[];return c.getEntries().forEach(n=>{if(n.isDirectory||e.length>0&&!e.includes((0,H.extname)(n.entryName)))return;s&&s(n.header.compressedSize);let l=a.getHash(n.getData(),"sha1");i.push({path:n.entryName,sha1:l}),c.extractEntryTo(n,r,!0,!0)}),i}};var E=(r=>(r.Allow="allow",r.Disallow="disallow",r))(E||{}),O=(e=>(e.Linux="linux",e.Osx="osx",e.Windows="windows",e))(O||{});0&&(module.exports={Action,HashHelper,HttpHelper,JsonHelper,Name,StorageHelper,ZipHelper});
//# sourceMappingURL=index.js.map